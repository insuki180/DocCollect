<script>
let SCRIPT_URL=null,API_KEY=null,companyKey=null;

async function loadBranding(){
const params=new URLSearchParams(window.location.search);
companyKey=params.get("company");
if(!companyKey)return;
const res=await fetch("companies.json");
const companies=await res.json();
const config=companies[companyKey];
document.getElementById("companyName").textContent=config.companyName;
document.getElementById("formTitle").textContent=config.formTitle;
if(config.logoUrl)
document.getElementById("brandLogo").innerHTML=`<img src="${config.logoUrl}">`;
document.documentElement.style.setProperty('--primary-color',config.primaryColor);
SCRIPT_URL=config.scriptUrl;
API_KEY=config.apiKey;
}
loadBranding();

/* Fresher toggle */
document.getElementById('experience').addEventListener('change',function(){
const section=document.getElementById('professionalSection');
if(this.value==="Fresher"){
section.style.opacity='.5';
section.style.pointerEvents='none';
section.querySelectorAll('input,select').forEach(i=>i.value="");
}else{
section.style.opacity='1';
section.style.pointerEvents='auto';
}
});

/* Drag-drop */
function setupDrop(input,label){
label.addEventListener('dragover',e=>{
e.preventDefault();
label.classList.add('dragover');
});
label.addEventListener('dragleave',()=>label.classList.remove('dragover'));
label.addEventListener('drop',e=>{
e.preventDefault();
label.classList.remove('dragover');
input.files=e.dataTransfer.files;
input.dispatchEvent(new Event('change'));
});
}
setupDrop(resumeFile,resumeDrop);
setupDrop(otherFiles,otherDrop);

/* Upload Handlers */
resumeFile.addEventListener('change',function(){
if(this.files[0]){
resumeFeedback.style.display='block';
resumeFeedback.textContent="üìÑ "+this.files[0].name;
}
});
otherFiles.addEventListener('change',function(){
if(this.files.length>0){
otherFeedback.style.display='block';
otherFeedback.textContent="üóÇÔ∏è "+this.files.length+" files selected";
}
});

/* Submit */
const form=document.getElementById('docCollectForm');
const overlay=document.getElementById('loadingOverlay');
const submitBtn=document.getElementById('submitBtn');
const progressFill=document.getElementById('progressFill');
const progressContainer=document.getElementById('progressContainer');

form.addEventListener('submit',async function(e){
e.preventDefault();
if(!SCRIPT_URL||!API_KEY)return;

overlay.style.display='flex';
submitBtn.disabled=true;

try{

/* Convert files */
const resumeB64=await toBase64(resumeFile.files[0]);

let otherDocsArray=[];
for(let i=0;i<otherFiles.files.length;i++){
const file=otherFiles.files[i];
const b64=await toBase64(file);
otherDocsArray.push({name:file.name,mimeType:file.type,data:b64});
}

overlay.style.display='none';
progressContainer.style.display='block';
progressFill.style.width='40%';

const payload={
apiKey:API_KEY,
company:companyKey,
name:form.name.value,
phone:form.phone.value,
email:form.email.value,
role:form.role.value,
experience:form.experience.value,
location:form.location.value,
current_ctc:form.current_ctc.value||'',
expected_ctc:form.expected_ctc.value||'',
notice_period:form.notice_period.value||'',
resume:{name:resumeFile.files[0].name,mimeType:resumeFile.files[0].type,data:resumeB64},
other_docs:otherDocsArray
};

/* üî• CORS SAFE FETCH */
await fetch(SCRIPT_URL,{
method:'POST',
mode:'no-cors',
headers:{
'Content-Type':'text/plain'
},
body:JSON.stringify(payload)
});

progressFill.style.width='100%';

/* Since no-cors hides response, assume success */
document.getElementById("formContainer").style.display='none';
document.getElementById("successScreen").style.display='block';
document.getElementById("successMessage").innerText=
`Thank you for applying to ${document.getElementById("companyName").innerText}.`;

}catch(err){
alert("Submission Failed: "+err.message);
}finally{
submitBtn.disabled=false;
}
});

const toBase64=file=>new Promise((resolve,reject)=>{
const reader=new FileReader();
reader.readAsDataURL(file);
reader.onload=()=>resolve(reader.result.split(',')[1]);
reader.onerror=reject;
});
</script>
